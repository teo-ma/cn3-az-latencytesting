## Azure cn3 (北三) 三可用区 (AZ) 跨AZ VM 内网 RTT 测试报告

本报告基于在 Azure cn3（北三）region 的三个可用区（AZ1、AZ2、AZ3）中部署的 3 台虚拟机进行的内网跨 AZ 延迟测试（使用 sockperf）。

测试环境与配置
- 区域：Azure cn3 (北三)
- VM 型号：Standard D8ads v6 (8 vCPU, 32 GiB, 含网络加速)
- 部署：
  - AZ1: VM1 - 私有 IP: `10.0.1.4`
  - AZ2: VM2 - 私有 IP: `10.0.2.4`
  - AZ3: VM3 - 私有 IP: `10.0.3.4`
- 网络：VNet Peering 已配置，使用 VNet 内网进行互联通信
- 测试工具：sockperf（测量 RTT，结果以微秒 us 为单位）

测试方法简述
- 在目标 VM 上运行 sockperf server，在源 VM 上运行 sockperf ping 测试若干次，收集 RTT 分位数与统计量（avg/min/max/p50/p90/p99）。

测试结果（单位：微秒 us）

| 源 → 目标 | 平均 (avg) | 最小 (min) | 最大 (max) | P50 | P90 | P99 |
|---:|---:|---:|---:|---:|---:|---:|
| AZ3 → AZ1 | 408.6 | 397.7 | 409.3 | 400.1 | 402.4 | 409.3 |
| AZ3 → AZ2 | 254.6 | 252.3 | 264.7 | 254.7 | 264.7 | 264.7 |
| AZ1 → AZ2 | 334.7 | 332.4 | 351.3 | 334.8 | 351.3 | 351.3 |
| AZ1 → AZ3 | 408.4 | 405.3 | 419.9 | 405.4 | 419.9 | 419.9 |
| AZ2 → AZ3 | 241.9 | 239.9 | 254.2 | 240.8 | 254.2 | 254.2 |
| AZ2 → AZ1 | 319.6 | 319.4 | 329.8 | 319.5 | 329.8 | 329.8 |

图像 — 测试过程截图

下面嵌入三张测试过程截图（位于仓库 `images/` 目录）：

![AZ1 VM 测试截图](images/az1-vm1.png)

![AZ2 VM 测试截图](images/az2-vm2.png)

![AZ3 VM 测试截图](images/az3-vm3.png)

网络拓扑图（含测试节点与私有 IP）

![网络拓扑图](images/networking.png)

（图中展示了 AZ1/2/3 的 VM 互联和所属私有 IP，便于理解测试路径。）

分析与结论
- 整体观察：跨 AZ 的 RTT 存在明显差异，且方向性有关（例如 AZ2 ↔ AZ3 路径明显低于 AZ1 ↔ AZ3 路径）。
- 最低延迟路径：AZ2 → AZ3 平均约 241.9 us，P99 254.2 us，显示该路径较稳定且延迟较低。
- 最高延迟路径：AZ3 ↔ AZ1 平均约 408 us，P99 409.3–419.9 us，明显高于其他路径，可能受 AZ 间网络跃点、路由或物理位置影响。
- 双向差异：同一路径的反向 RTT（例如 AZ3 → AZ1 与 AZ1 → AZ3）非常接近，但仍存在小幅差值（408.6 vs 408.4），总体一致性良好；而 AZ2 ↔ AZ1 的双向差异也较小（319.6 vs 334.7 平均），但方向性差异提示路由/转发路径可能不同。

可能原因（需进一步验证）
- AZ 的物理拓扑或边缘路由不同导致的额外跃点。
- 路由策略、网络加速/NIC 分配或超额认购导致的差异。
- VNet Peering 跨子网或跨虚拟网络的实现差异。

建议的后续验证步骤
1. 在相同时间窗口内重复多轮测试以验证一致性（不同时间段/不同负载）。
2. 使用 tcpdump 或 Azure 网络监控工具抓包，定位是否存在中间跃点或重传。
3. 检查 NSG、UDR、路由表和负载均衡器配置，确认没有意外的路径偏移。
4. 尝试不同 VM SKU（有/无网络加速）比较差异。

附录 — 数据契约与测试命令示例
- 输入：源 VM 发起 sockperf ping 到目标 VM 的私有 IP。
- 输出：sockperf 输出的统计值（avg/min/max/p50/p90/p99），单位 us。
- 错误模式：网络抖动、丢包或权限限制会导致测量异常。

示例命令（仅供参考）
```bash
# 在目标 VM 上运行 server
sockperf server &

# 在源 VM 上运行 ping（示例）
sockperf ping-pong --ip 10.0.3.4 --time 10
```

报告生成与验证
- 本文件由测试数据与用户提供的截图生成。图片文件位于 `images/` 目录下。

下一步：我会验证图片路径并把 TODO 项标记完成。若需我同时生成 CSV / 图表或把结果放入 HTML 报告，也可以继续扩展。

---

完成状态：此 README 已基于您提供的数据生成。如需改动文本风格、增加更多可视化图表或添加 raw sockperf 输出，请告诉我要添加的内容。

免责声明
--
此次测试结果仅基于作者在特定时间点、特定 Azure cn3（北三）region 配置和 VM SKU 下的测试环境与方法。测试数据仅供参考，不代表 Microsoft/Azure 官方的性能或网络质量测量结果。若需要官方基准或正式验证，请联系 Azure 支持或使用 Microsoft 提供的标准化测试工具与方法。
